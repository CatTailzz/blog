---
title: 重新理解计算机网络1：理解网络层之下
subtitle: 
date: 2024-08-23T19:27:51+08:00
slug: 58d03c9
draft: false
tags:
  - 计算机网络
categories:
  - 计算机网络
password: 
message:
---
# 前言

过去在学习计算机网络这门学科时，对于它的分层架构理解困难，核心问题在于：为什么要分层？为什么这一层干这个事？层与层之间是什么关系？现实中如何感知某一层？XX层到底是一个什么形态？

我想这些都是因为学习方式有误，不带着场景和问题出发，而是直接抛出一个方案，难免让人摸不着头脑。所以本文将从实际需求出发，逐步构建出现代计算机网络的分层架构，并在过程中回答上述的问题。

# 需求

把计算机网络的需求抽象到最小的模型，就是【问题A】解决两台异地电脑的通信问题。

逐步扩展，就是【问题B】解决N台小范围内电脑的通信问题。

再扩展，就是【问题C】解决全球所有电脑的通信问题。

我们一步步来解决

# 问题A，解决两台异地电脑的通信问题

这个问题很简单，直接拿条线把两个设备连接起来，然后传高低电平的电信号就可以传输信息了。

那这个方案扩展性如何呢？如果我有3台设备，那么就需要3条线，如果我有4台设备，两两连接就需要6条线，最后发现线的数量比设备多一个数量级，这不是一个合理的拓展方案。

聪明的大伙一定想到了，可以用到*转发*的思想，专门设计一个转发器作为中转站，接收信号并传递出去，这其实就是早期的设计，集线器 Hub，不过最初它有几个问题

1. 接收到信号后无法分辨目的地，只能做广播式转发
2. 当a发送时，c无法同时发送，否则会导致信号交杂紊乱，这是因为集线器的设计模式是半双工的，即便他们的线缆支持全双工

![image.png](https://obsidian-img-1300316500.cos.ap-shanghai.myqcloud.com/cattail/obsidian/pic/202408232000463.png)

问题1其实在小规模的网络里还算可以接受，我只需要给每个设备一个*标识符*，然后在发送信息时带上目标标识，其他设备接收到数据后，发现这个数据不是给我的，直接丢弃即可。

问题2的解决就需要依赖一些协议，这里为此设计了 CSMA/CD 协议，通过监测碰撞来管理数据的传输，当发生碰撞时会等待一段时间再发送。

## 继续思考缺陷

虽然 CSMA/CD 协议解决了碰撞问题，但本质上同一时间还是只能有一台设备在发送，这样效率太低，假设我的设备规模进一步扩大，所有设备都争夺一个发送权，是效率低下的。

另外，广播的方式也效率低下，当网络规模进一步扩大时，带宽利用率很低，大部分消息都是无效转发。

# 问题B，解决多台设备在小范围内的通信问题

怎么解决上面两个问题，一是要设计一种全双工的收发模型，二是要减少广播，最好可以直接知道要转发到哪个设备。

这里就引出了交换机，它是怎么实现点对点转发的呢？

![image.png](https://obsidian-img-1300316500.cos.ap-shanghai.myqcloud.com/cattail/obsidian/pic/202408232032114.png)

这里首先需要对前文提到的*标识符*做一个补充，现代计算机网络对其的具体实现方式是 *MAC 地址*，它是绑定设备，全球唯一的，交换机的每个端口连接一个设备，并且维护一张MAC地址表，包含了每个端口连接设备的MAC 地址。在收到消息后，解析出其中的 MAC 地址然后查表，就能知道该走哪个端口了。

那如果查不到呢？或者说一台初始状态的交换机，是怎么建立起MAC地址表的呢？这其实类似于 ARP 的思想，当收到消息时，可以确认发送方的 MAC 地址和端口，写一次表，当发现表中没有目的 MAC 地址的信息时，做一次广播，等待正确接收方的响应，再记录一次表。以此逐步完善信息，并且这个表的记录有一个过期时间，来应对增减设备的问题。

这么做自然而然的也就解决了半双工的问题，交换机是全双工的。因为它不再依赖广播和共享介质，可以区分同时发生的发送和接收信号。

最后，交换机支持一定的扩展，它可以通过桥接把更多的设备管理起来，MAC表最多可达几千条。

![image.png](https://obsidian-img-1300316500.cos.ap-shanghai.myqcloud.com/cattail/obsidian/pic/202408232052643.png)

## 思考缺陷

目前看起来在小范围内的局域网，比如校园网、工作室网内有了一个可用且高效的模型，但如何拓展到全球范围内的网络呢？单靠交换机无限的桥接肯定是不行的，这样在找一个MAC地址时会无限制的广播，最后导致洪范，导致广播风暴，阻塞网络。

# 问题C，解决全球范围内的网络通信问题

从小范围的局域网通信，拓展到全球范围内的网络通信，思路在计算机领域的各种模型的设计中是很常见的，就是再升一维，也就是再抽象出一层，这就是我们的网络层了。

![image.png](https://obsidian-img-1300316500.cos.ap-shanghai.myqcloud.com/cattail/obsidian/pic/202408281609019.png)


这里引出了一个 IP 的概念，需要纠正一下我过去错误的认知，IP 并不能像 MAC 一样来永久标识一台设备。它的标识是抽象的、分层的，IP 用于标识一个子网络，或者标识一个设备在这个子网络下的位置。

在两个网络之间用路由器来关联，有点类似于交换机，他会维护一个路由表，用于根据 IP 来转发信息。至于网络内部的通信，还是需要用 MAC 地址来查找，用 ARP 协议来广播目的 IP，持有这个 IP 的设备响应自己的 MAC 地址，最终数据包的目的 MAC 地址确定后，才能进行正确传输。

# 一些问题

- 交换机和集线器是什么关系，是上层关系还是替代关系？
	- 是替代关系，交换机比集线器更优越
- 路由器有 WAN 口和 LAN 口，有什么区别？一个口对应一张网卡吗？
	- WAN 口是连接到广域网的，LAN 口是连接到局域网的，在家庭路由器的表现就是，WAN 口从外面拉网线来通网，LAN 口给家里其他设备供网。它们在带宽性能、安全性、配置和协议上均有不同。
	- 网口和网卡并无对应关系，但通常网口数量会多于网卡，对于路由器来说通常是一张网卡，并且是服务于 WAN 口的。
- 路由器有多少个 IP？
	- 通常是 2 个，即 WAN 侧和 LAN 侧，当然也可以为网卡增加 IP。
- 手机是怎么连接到路由器的？
	- 手机主动搜索附近的 WiFi 信号，验证身份进行连接，之后路由器通过 DHCP 协议为手机分配 IP 地址，允许手机和局域网内其他设备通信，这其中也包含了 WAN 侧的外部广域网，实现了上网功能。
- 什么是 NAT 协议？
	- 主要用于解决全球 IP 地址短缺的问题，在局域网内通信时，分配一个无关紧要的公网 IP。当需要连接外部时，NAT来负责 IP 地址的转换。