---
title: 站内消息系统
subtitle: 
date: 2024-09-07T19:55:54+08:00
slug: 686e32b
draft: true
tags:
  - draft
categories:
  - draft
password: 
message:
---
# 场景问题

如何实现一个站内消息系统，要实现群发和私信的功能，如何设计？系统架构如何？需要运用什么功能模块？

# 形态

站内消息通知的形态，通常是后台管理人员创建一个消息，并指定一个用户组或用户接收。拓展开来可以是消息推送系统，可以延伸出定时推送、出站推送（其他媒介如邮件短信）、消息模板（html、甚至带请求接口）、消息生命周期链路追踪（确认状态或回执）。

我们先不管其他方面，从最简单的文本消息考虑，一条消息的生命周期是怎么样的？
- 管理人员制定消息内容和接收方，点击发送（假设是实时），此时一条消息所需的基本内容有了，即消息id、发送方和接收方id、消息内容、消息类型、发送时间、发送状态。可以进行消息存储。
- 消息通知到接收方，以B站为例，站内消息不管私信、事件、系统消息，都在消息模块下。那么接收方登录系统接收消息这个功能怎么实现好呢？我们先考虑简单的主动请求接口查表。这里的查表就是一个主要挑战

# 难点

## 如何高效从海量消息表中获取正确的消息？

可以按用户id、消息时间、甚至用户活跃度作为分片来分表。也可以加索引

针对群发的热点消息，比如全站通知等，也可以特殊处理，比如存redis里，等热度过去后再放数据库，针对冷热消息都可以用类似的思路。

## 如何从点赞、评论事件跳转到事件发生位置？

需要额外的表进行关联，记录一些内容id、URL或发生位置，两表通过消息id来关联，在用户点击行为时根据消息类型再查表进行逻辑跳转操作。

## 给海量用户发群发消息，如何优化？

本质可以是写数据库的行为，如果是全站用户可以特殊处理，比如只有一条特殊消息数据，对应的代码逻辑里也加一些特判

常规思路就是消息队列来异步削峰、分批处理

## 消息发送失败？如何追踪？

监控系统、重试机制。其实并不了解这一块的应用